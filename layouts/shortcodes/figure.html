{{/*
    Custom `figure` shortcode with image processing.
    Overrides Hugo's built-in `figure` shortcode.

    Usage:
    {{< figure
        src="image.jpg"
        alt="Alternative text"
        caption="Optional caption"
        class="custom-class"
        link="https://example.com"
        target="_blank"
        rel="noopener"
        width="100"
        height="100"
        loading="lazy"
        title="Optional title for figcaption"
        attr="Attribution text"
        attrlink="https://example.com/attribution"
    >}}
*/}}
<figure{{ with .Get "class" }} class="{{ . }}"{{ end }}>
    {{- $src := .Get "src" -}}
    {{- $alt := .Get "alt" | default (.Get "caption") -}}
    {{- $caption := .Get "caption" -}}
    {{- $title := .Get "title" -}}
    {{- $link := .Get "link" -}}
    {{- $target := .Get "target" | default "_blank" -}}
    {{- $rel := .Get "rel" | default "noopener" -}}
    {{- $width := .Get "width" -}}
    {{- $height := .Get "height" -}}
    {{- $loading := .Get "loading" | default "lazy" -}}
    {{- $attr := .Get "attr" -}}
    {{- $attrlink := .Get "attrlink" -}}

    {{- $image := .Page.Resources.GetMatch $src -}}
    {{- if not $image }}{{ $image = resources.Get $src }}{{ end -}}

    {{- if $link -}}
        <a href="{{ $link }}" target="{{ $target }}" rel="{{ $rel }}">
    {{- end -}}

    {{ if $image }}
        {{/* Generate responsive images */}}
        {{ $small := $image.Resize "480x" }}
        {{ $medium := $image.Resize "768x" }}
        {{ $large := $image.Resize "1024x" }}

        <picture>
            <source media="(max-width: 480px)" srcset="{{ $small.RelPermalink }}">
            <source media="(max-width: 768px)" srcset="{{ $medium.RelPermalink }}">
            <source media="(min-width: 769px)" srcset="{{ $large.RelPermalink }}">
            <img src="{{ $large.RelPermalink }}" alt="{{ $alt }}"
                {{- with $width }} width="{{ . }}"{{ end -}}
                {{- with $height }} height="{{ . }}"{{ end -}}
                loading="{{ $loading }}">
        </picture>
    {{ else }}
        {{/* Fallback for external images or images not found in resources */}}
        <img src="{{ $src }}" alt="{{ $alt }}"
            {{- with $width }} width="{{ . }}"{{ end -}}
            {{- with $height }} height="{{ . }}"{{ end -}}
            loading="{{ $loading }}">
    {{ end }}

    {{- if $link -}}
        </a>
    {{- end -}}

    {{- if or $title $caption $attr -}}
        <figcaption>
            {{ with $title }}<h4>{{ . }}</h4>{{ end }}
            {{ if or $caption $attr }}
                <p>
                    {{ $caption | .Page.RenderString }}
                    {{- with $attrlink -}}<a href="{{ . }}">{{- end -}}
                    {{- $attr | .Page.RenderString -}}
                    {{- if $attrlink -}}</a>{{- end -}}
                </p>
            {{ end }}
        </figcaption>
    {{- end -}}
</figure>
